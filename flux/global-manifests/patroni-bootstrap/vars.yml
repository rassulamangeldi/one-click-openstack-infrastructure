---

cluster_vip: "10.129.2.70"
keepalived_virtual_router_id: 70

patroni_cluster_name: "stage-mycar-pg"
patroni_superuser_username: postgres
patroni_superuser_password: "test"
patroni_replication_password: "test"

with_haproxy_load_balancing: true
haproxy_listen_port:
  master: 15432
  replicas: 25432
  replicas_sync: 5002
  replicas_async: 5003
  stats: 7000
  postgres_direct: 35432

dcs_type: etcd

postgresql_version: 14
postgresql_port: 5432
postgresql_password_encryption_algorithm: "md5"

postgresql_users:
  - { name: "{{ pgbouncer_auth_username }}", password: "{{ pgbouncer_auth_password }}", flags: "LOGIN", role: "" }
  - { name: "{{ monitoring_auth_username }}", password: "{{ monitoring_auth_password }}", flags: "LOGIN", role: "pg_monitor" }

postgresql_extensions:
  - { ext: "pg_stat_statements", db: "" }

postgresql_pg_hba:
  - { type: "local", database: "all", user: "{{ patroni_superuser_username }}", address: "", method: "trust" }
  - { type: "local", database: "all", user: "{{ pgbouncer_auth_username }}", address: "", method: "trust" }
  - { type: "local", database: "all", user: "{{ monitoring_auth_username }}", address: "", method: "trust" }
  - { type: "local", database: "replication", user: "{{ patroni_superuser_username }}", address: "", method: "trust" }
  - { type: "local", database: "all", user: "all", address: "", method: "{{ postgresql_password_encryption_algorithm }}" }
  - { type: "host", database: "all", user: "all", address: "127.0.0.1/32", method: "{{ postgresql_password_encryption_algorithm }}" }
  - { type: "host", database: "all", user: "all", address: "::1/128", method: "{{ postgresql_password_encryption_algorithm }}" }
  - { type: "host", database: "all", user: "all", address: "0.0.0.0/0", method: "{{ postgresql_password_encryption_algorithm }}" }

postgresql_parameters:
  - { option: "max_connections", value: "1800" }
  - { option: "superuser_reserved_connections", value: "3" }
  - { option: "password_encryption", value: "{{ postgresql_password_encryption_algorithm }}" }
  - { option: "max_locks_per_transaction", value: "64" }
  - { option: "max_prepared_transactions", value: "0" }
  - { option: "shared_buffers", value: "4GB" }
  - { option: "effective_cache_size", value: "4GB" }
  - { option: "work_mem", value: "2MB" }  
  - { option: "maintenance_work_mem", value: "64MB" }
  - { option: "checkpoint_timeout", value: "5min" }
  - { option: "checkpoint_completion_target", value: "0.9" }
  - { option: "min_wal_size", value: "1GB" }
  - { option: "max_wal_size", value: "4GB" }
  - { option: "max_worker_processes", value: "8" }
  - { option: "max_parallel_workers_per_gather", value: "2" }
  - { option: "max_parallel_workers", value: "8" }
  - { option: "max_parallel_maintenance_workers", value: "2" } 
  - { option: "wal_buffers", value: "16MB" }
  - { option: "seq_page_cost", value: "1" }
  - { option: "random_page_cost", value: "1.1" }
  - { option: "effective_io_concurrency", value: "1" }
  - { option: "huge_pages", value: "off" }
  - { option: "synchronous_commit", value: "on" }
  - { option: "max_files_per_process", value: "1000" }
  - { option: "archive_mode", value: "on" }
  - { option: "archive_timeout", value: "1800s" }
  - { option: "archive_command", value: "{{ pgbackrest_archive_command }}" }
  - { option: "wal_level", value: "logical" }
  - { option: "wal_keep_size", value: "128MB" }
  - { option: "max_wal_senders", value: "20" }
  - { option: "max_replication_slots", value: "20" }
  - { option: "hot_standby", value: "on" }
  - { option: "wal_log_hints", value: "on" }
  - { option: "wal_compression", value: "off" }
  - { option: "shared_preload_libraries", value: "pg_stat_statements,auto_explain" }
  - { option: "pg_stat_statements.max", value: "10000" }
  - { option: "pg_stat_statements.track", value: "all" }
  - { option: "pg_stat_statements.save", value: "true" }
  - { option: "log_lock_waits", value: "off" }
  - { option: "log_temp_files", value: "-1" }
  - { option: "log_checkpoints", value: "off" }
  - { option: "logging_collector", value: "on" }
  - { option: "log_truncate_on_rotation", value: "on" }
  - { option: "log_rotation_age", value: "1d" }
  - { option: "log_rotation_size", value: "10MB" }
  - { option: "log_line_prefix", value: "%t [%p-%l] %r %q%u@%d " }
  - { option: "log_filename", value: "postgresql-%a.log" }
  - { option: "log_directory", value: "{{ postgresql_log_dir }}" }

pgbouncer_install: false

pgbackrest_install: false


# pgbackrest_cron_jobs:
#   - name: "pgBackRest: Full Backup"
#     file: "/etc/cron.d/pgbackrest-{{ patroni_cluster_name }}"
#     user: "postgres"
#     minute: "00"
#     hour: "{{ PGBACKREST_BACKUP_HOUR | default('3') }}"
#     day: "*"
#     month: "*"
#     weekday: "0"
#     job: "if [ $(psql -tAXc 'select pg_is_in_recovery()') = 'f' ]; then pgbackrest --stanza={{ pgbackrest_stanza }} --type=full backup; fi"
#   - name: "pgBackRest: Diff Backup"
#     file: "/etc/cron.d/pgbackrest-{{ patroni_cluster_name }}"
#     user: "postgres"
#     minute: "00"
#     hour: "3"
#     day: "*"
#     month: "*"
#     weekday: "1-6"
#     job: "if [ $(psql -tAXc 'select pg_is_in_recovery()') = 'f' ]; then pgbackrest --stanza={{ pgbackrest_stanza }} --type=diff backup; fi"


## System variables
timezone: "Asia/Almaty"

sysctl_conf:
  postgres_cluster:
    - { name: "vm.overcommit_memory", value: "2" }
    - { name: "vm.swappiness", value: "1" }
    - { name: "vm.min_free_kbytes", value: "102400" }
    - { name: "vm.dirty_expire_centisecs", value: "1000" }
    - { name: "vm.dirty_background_bytes", value: "67108864" }
    - { name: "vm.dirty_bytes", value: "536870912" }
    - { name: "vm.zone_reclaim_mode", value: "0" }
    - { name: "kernel.numa_balancing", value: "0" }
    - { name: "kernel.sched_autogroup_enabled", value: "0" }
    - { name: "net.ipv4.ip_nonlocal_bind", value: "1" }
    - { name: "net.ipv4.ip_forward", value: "1" }
    - { name: "net.core.netdev_max_backlog", value: "10000" }
    - { name: "net.ipv4.tcp_max_syn_backlog", value: "8192" }
    - { name: "net.core.somaxconn", value: "65535" }
    - { name: "net.ipv4.tcp_tw_reuse", value: "1" }
  balancers:
    - { name: "net.ipv4.ip_nonlocal_bind", value: "1" }
    - { name: "net.ipv4.ip_forward", value: "1" }
    - { name: "net.ipv4.ip_local_port_range", value: "10000 65535" }
    - { name: "net.core.netdev_max_backlog", value: "10000" }
    - { name: "net.ipv4.tcp_max_syn_backlog", value: "8192" }
    - { name: "net.core.somaxconn", value: "65535" }
    - { name: "net.ipv4.tcp_tw_reuse", value: "1" }

# etc_hosts: ['10.129.51.7 prometheus.mycar.kz']

